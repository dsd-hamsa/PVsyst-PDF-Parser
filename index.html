<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PVsyst PDF Parser (V3)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1120;
      color: #e5e7eb;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 2rem 1rem;
    }
    .app {
      width: 100%;
      max-width: 1100px;
      background: #020617;
      border-radius: 1rem;
      padding: 1.75rem;
      box-shadow: 0 24px 80px rgba(0,0,0,0.7);
      border: 1px solid #1e293b;
    }
    h1 {
      margin-top: 0;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .muted {
      color: #9ca3af;
      font-size: 0.9rem;
    }
    .upload-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin: 1.25rem 0 1.75rem;
      align-items: center;
    }
    input[type="file"] {
      color: #e5e7eb;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.5rem 1.5rem;
      font-size: 0.95rem;
      cursor: pointer;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .status {
      margin-top: 0.25rem;
      min-height: 1.25rem;
      font-size: 0.9rem;
    }
    .status.error {
      color: #f97373;
    }
    .status.ok {
      color: #4ade80;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .card {
      background: #020617;
      border-radius: 0.75rem;
      padding: 1rem;
      border: 1px solid #111827;
    }
    .card h2 {
      font-size: 1rem;
      margin: 0 0 0.5rem;
    }
    .kvs {
      font-size: 0.9rem;
    }
    .kvs div {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin: 0.15rem 0;
    }
    .kvs span.key {
      color: #9ca3af;
    }
    .kvs span.val {
      text-align: right;
      color: #e5e7eb;
    }
    details {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #111827;
      margin-top: 0.5rem;
      padding: 0.25rem 0.75rem 0.75rem;
    }
    details summary {
      cursor: pointer;
      padding: 0.25rem 0;
      font-size: 0.95rem;
      font-weight: 500;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }
    th, td {
      padding: 0.25rem 0.4rem;
      border-bottom: 1px solid #111827;
      vertical-align: top;
    }
    th {
      text-align: left;
      color: #9ca3af;
      font-weight: 500;
    }
    code {
      font-size: 0.8rem;
      background: #020617;
      padding: 0.15rem 0.35rem;
      border-radius: 0.35rem;
      border: 1px solid #111827;
    }
  </style>
</head>
<body>
  <main class="app">
    <h1>ðŸ“„ PVsyst PDF Parser (V3)</h1>
    <p class="muted">
      Upload a PVsyst report PDF to extract inverter + MPPT configuration for monitoring.
    </p>

    <div class="upload-row">
      <input id="fileInput" type="file" accept="application/pdf" />
      <button id="parseBtn">Parse PDF</button>
      <span class="muted">API URL: <code id="apiUrlLabel"></code></span>
    </div>
    <div class="status" id="status"></div>

    <div id="results" style="display:none;">
      <div class="grid">
        <section class="card" id="summaryCard"></section>
        <section class="card" id="moduleCard"></section>
        <section class="card" id="inverterCard"></section>
      </div>

      <section class="card" style="margin-top:1rem;">
        <h2>MPPT configuration (combined)</h2>
        <div id="mppt"></div>
      </section>

      <section class="card" style="margin-top:1rem;">
        <h2>Array configurations</h2>
        <div id="arrays"></div>
      </section>

      <section class="card" style="margin-top:1rem;">
        <h2>Inverter monthly production</h2>
        <div id="inverters"></div>
      </section>
    </div>
  </main>

  <script>
    // Change this if you deploy the API elsewhere
    const API_BASE = location.origin.includes("github.io")
      ? "https://YOUR-BACKEND-HOST/api"  // <-- set this for GitHub Pages
      : "http://localhost:8888/api";

    document.getElementById("apiUrlLabel").textContent = API_BASE + "/parse";

    const fileInput = document.getElementById("fileInput");
    const parseBtn = document.getElementById("parseBtn");
    const statusEl = document.getElementById("status");
    const resultsEl = document.getElementById("results");

    parseBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) {
        setStatus("Please choose a PVsyst PDF first.", "error");
        return;
      }

      setStatus("Uploading and parsingâ€¦", "ok");
      parseBtn.disabled = true;
      resultsEl.style.display = "none";

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch(API_BASE + "/parse", { method: "POST", body: formData });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || "Parsing failed");
        }

        const data = await res.json();
        window.lastParsed = data;
        renderResults(data);
        setStatus("Parsed successfully.", "ok");
      } catch (err) {
        console.error(err);
        setStatus(err.message || "Error during parsing", "error");
      } finally {
        parseBtn.disabled = false;
      }
    });

    function setStatus(msg, kind) {
      statusEl.textContent = msg;
      statusEl.className = "status " + (kind || "");
    }

    function renderResults(data) {
      resultsEl.style.display = "block";

      renderSummary(data);
      renderModuleInfo(data.pv_module || {});
      renderInverterInfo(data);
      renderMpptCombined(data.inverter_summary || {});
      renderArrays(data.array_configurations || {});
      renderInverterMonthly(data.inverter_summary || {});
    }

    function renderSummary(d) {
      const el = document.getElementById("summaryCard");
      const m = d.metadata || {};
      const arrays = d.array_configurations || {};

      // Derive totals client-side (V3 metadata intentionally minimal)
      let totalModules = 0;
      let totalStrings = 0;
      for (const a of Object.values(arrays)) {
        if (a && a.number_of_modules != null) totalModules += Number(a.number_of_modules) || 0;
        if (a && a.strings != null) totalStrings += Number(a.strings) || 0;
      }

      el.innerHTML = `
        <h2>System summary</h2>
        <div class="kvs">
          <div><span class="key">Arrays</span><span class="val">${m.total_arrays ?? Object.keys(arrays).length ?? "â€”"}</span></div>
          <div><span class="key">Inverters</span><span class="val">${m.total_inverters ?? Object.keys(d.inverter_summary || {}).length ?? "â€”"}</span></div>
          <div><span class="key">Modules</span><span class="val">${totalModules ? totalModules.toLocaleString() : "â€”"}</span></div>
          <div><span class="key">Strings</span><span class="val">${totalStrings ? totalStrings.toLocaleString() : "â€”"}</span></div>
          <div><span class="key">Capacity</span><span class="val">${fmtNum(m.total_system_capacity_kwp)} kWp</span></div>
          <div><span class="key">Annual prod.</span><span class="val">${fmtNum(m.total_annual_production_kwh)} kWh</span></div>
        </div>
      `;
    }

    function renderModuleInfo(m) {
      const el = document.getElementById("moduleCard");
      el.innerHTML = `
        <h2>PV module</h2>
        <div class="kvs">
          <div><span class="key">Manufacturer</span><span class="val">${m.manufacturer || "â€”"}</span></div>
          <div><span class="key">Model</span><span class="val">${m.model || "â€”"}</span></div>
          <div><span class="key">Unit Nom. Power</span><span class="val">${m.unit_nom_power_w ? m.unit_nom_power_w + " W" : "â€”"}</span></div>
        </div>
      `;
    }

    function renderInverterInfo(data) {
      const el = document.getElementById("inverterCard");
      const globalInv = data.inverter || {};
      const types = Array.isArray(data.inverter_types) ? data.inverter_types : [];
      const invSummary = data.inverter_summary || {};

      const countsByTypeId = {};
      for (const inv of Object.values(invSummary)) {
        const t = inv && inv.inverter_type;
        if (t && t.id) {
          countsByTypeId[t.id] = (countsByTypeId[t.id] || 0) + 1;
        }
      }

      let html = `<h2>Inverters</h2>`;

      const hasGlobal = globalInv && (globalInv.manufacturer || globalInv.model || globalInv.unit_nom_power_kw != null);
      if (hasGlobal) {
        html += `
          <p class="muted">Default inverter (from PVsyst equipment table)</p>
          <div class="kvs">
            <div><span class="key">Manufacturer</span><span class="val">${globalInv.manufacturer || "â€”"}</span></div>
            <div><span class="key">Model</span><span class="val">${globalInv.model || "â€”"}</span></div>
            <div><span class="key">Unit Nom. Power</span><span class="val">${globalInv.unit_nom_power_kw != null ? globalInv.unit_nom_power_kw + " kW" : "â€”"}</span></div>
          </div>
        `;
      }

      if (types.length) {
        html += `<p class="muted" style="margin-top:0.75rem;">Inverter models detected</p>`;
        html += `
          <table>
            <thead>
              <tr>
                <th>Type ID</th>
                <th>Count</th>
                <th>Manufacturer</th>
                <th>Model</th>
                <th>kW</th>
              </tr>
            </thead>
            <tbody>
              ${types.map(t => {
                const count = countsByTypeId[t.id] || "â€”";
                const kw = (t.unit_nom_power_kw != null) ? t.unit_nom_power_kw : "â€”";
                return `
                  <tr>
                    <td>${t.id || "â€”"}</td>
                    <td>${count}</td>
                    <td>${t.manufacturer || "â€”"}</td>
                    <td>${t.model || "â€”"}</td>
                    <td>${kw}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        `;
      } else {
        // Fallback: show distinct inverter types derived from inverter_summary (if present)
        const inferred = new Map();
        for (const inv of Object.values(invSummary)) {
          const t = inv && inv.inverter_type;
          if (!t) continue;
          const key = JSON.stringify({ manufacturer: t.manufacturer || null, model: t.model || null, kw: t.unit_nom_power_kw || null });
          inferred.set(key, t);
        }
        if (inferred.size) {
          html += `<p class="muted" style="margin-top:0.75rem;">Inverter models detected</p>`;
          html += `
            <table>
              <thead>
                <tr>
                  <th>Manufacturer</th>
                  <th>Model</th>
                  <th>kW</th>
                </tr>
              </thead>
              <tbody>
                ${Array.from(inferred.values()).map(t => {
                  const kw = (t.unit_nom_power_kw != null) ? t.unit_nom_power_kw : "â€”";
                  return `
                    <tr>
                      <td>${t.manufacturer || "â€”"}</td>
                      <td>${t.model || "â€”"}</td>
                      <td>${kw}</td>
                    </tr>
                  `;
                }).join("")}
              </tbody>
            </table>
          `;
        }
      }

      el.innerHTML = html;
    }

    function renderMpptCombined(invSummary) {
      const el = document.getElementById("mppt");
      if (!invSummary || Object.keys(invSummary).length === 0) {
        el.innerHTML = "<p class='muted'>No MPPT configuration found.</p>";
        return;
      }

      el.innerHTML = "";

      for (const [invId, inv] of Object.entries(invSummary)) {
        const details = document.createElement("details");
        details.open = false;
        const title = inv.description || invId;
        details.innerHTML = `<summary>${title}</summary>`;

        const combined = inv.combined_configuration || [];
        if (!combined.length) {
          const p = document.createElement("p");
          p.className = "muted";
          p.textContent = "No combined configuration.";
          details.appendChild(p);
          el.appendChild(details);
          continue;
        }

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th>MPPT</th>
            <th>Config</th>
            <th>Strings</th>
            <th>Modules</th>
            <th>Mods/Str</th>
            <th>DC kWp</th>
            <th>Tilt</th>
            <th>Azimuth</th>
            <th>U mpp (V)</th>
            <th>I mpp (A)</th>
          </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        for (const row of combined) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.mppt ?? "â€”"}</td>
            <td>${row.config_id ?? "â€”"}</td>
            <td>${row.strings ?? "â€”"}</td>
            <td>${row.modules ?? "â€”"}</td>
            <td>${row.modules_in_series ?? "â€”"}</td>
            <td>${fmtNum(row.dc_kwp)}</td>
            <td>${row.tilt != null ? row.tilt + "Â°" : "â€”"}</td>
            <td>${row.azimuth != null ? row.azimuth + "Â°" : "â€”"}</td>
            <td>${row.u_mpp_v ?? "â€”"}</td>
            <td>${row.i_mpp_a ?? "â€”"}</td>
          `;
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        details.appendChild(table);
        el.appendChild(details);
      }
    }

    function renderArrays(arrays) {
      const el = document.getElementById("arrays");
      if (!arrays || Object.keys(arrays).length === 0) {
        el.innerHTML = "<p class='muted'>No array configuration found.</p>";
        return;
      }

      el.innerHTML = "";

      for (const [id, a] of Object.entries(arrays)) {
        const tilt = a.tilt ?? "â€”";
        const az = a.azimuth_compass_deg ?? a.azimuth_deg ?? "â€”";

        const mods = a.number_of_modules ?? "â€”";
        const kwp = a.nominal_stc_kwp ?? a.nominal_stc_kwp_from_module ?? "â€”";
        const strings = a.strings ?? "â€”";
        const series = a.modules_in_series ?? "â€”";
        const orientationId = a.orientation_id ?? "â€”";

        const details = document.createElement("details");
        details.innerHTML = `
          <summary>Config #${id} - ${mods} modules - ${fmtNum(kwp)} kWp</summary>
          <div class="kvs">
            <div><span class="key">Orientation #</span><span class="val">${orientationId}</span></div>
            <div><span class="key">Tilt</span><span class="val">${tilt}Â°</span></div>
            <div><span class="key">Azimuth (compass)</span><span class="val">${az}Â°</span></div>
            <div><span class="key">Strings</span><span class="val">${strings}</span></div>
            <div><span class="key">Modules / string</span><span class="val">${series}</span></div>
            <div><span class="key">U mpp</span><span class="val">${a.u_mpp_v ?? "â€”"} V</span></div>
            <div><span class="key">I mpp</span><span class="val">${a.i_mpp_a ?? "â€”"} A</span></div>
          </div>
        `;
        el.appendChild(details);
      }
    }

    function renderInverterMonthly(invSummary) {
      const el = document.getElementById("inverters");
      if (!invSummary || Object.keys(invSummary).length === 0) {
        el.innerHTML = "<p class='muted'>No per-inverter monthly allocation found.</p>";
        return;
      }

      el.innerHTML = "";
      const monthOrder = [
        "January","February","March","April","May","June",
        "July","August","September","October","November","December"
      ];

      for (const [invId, inv] of Object.entries(invSummary)) {
        const displayName = inv.description || invId;
        const details = document.createElement("details");
        details.innerHTML = `
          <summary>${displayName} Â· ${fmtNum(inv.capacity_kwp)} kWp Â· ${fmtNum(inv.annual_production_kwh)} kWh/yr</summary>
        `;

        const monthly = inv.monthly_production || {};
        if (Object.keys(monthly).length) {
          const table = document.createElement("table");
          const thead = document.createElement("thead");
          thead.innerHTML = "<tr><th>Month</th><th>E_Grid [kWh]</th></tr>";
          table.appendChild(thead);

          const tbody = document.createElement("tbody");
          for (const m of monthOrder) {
            if (monthly[m] == null) continue;
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${m}</td><td>${fmtNum(monthly[m])}</td>`;
            tbody.appendChild(tr);
          }
          table.appendChild(tbody);
          details.appendChild(table);
        } else {
          const p = document.createElement("p");
          p.className = "muted";
          p.textContent = "No monthly data.";
          details.appendChild(p);
        }

        el.appendChild(details);
      }
    }

    function fmtNum(v) {
      if (v == null || Number.isNaN(+v)) return "â€”";
      return Number(v).toLocaleString(undefined, { maximumFractionDigits: 2 });
    }
  </script>
</body>
</html>
